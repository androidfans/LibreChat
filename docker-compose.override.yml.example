# Please consult our docs for more info: https://www.librechat.ai/docs/configuration/docker_override

# TO USE THIS FILE, FIRST UNCOMMENT THE LINE ('services:')

# THEN UNCOMMENT ONLY THE SECTION OR SECTIONS CONTAINING THE CHANGES YOU WANT TO APPLY
# SAVE THIS FILE AS 'docker-compose.override.yaml'
# AND USE THE 'docker compose build' & 'docker compose up -d' COMMANDS AS YOU WOULD NORMALLY DO

# WARNING: YOU CAN ONLY SPECIFY EVERY SERVICE NAME ONCE (api, mongodb, meilisearch, ...)
# IF YOU WANT TO OVERRIDE MULTIPLE SETTINGS IN ONE SERVICE YOU WILL HAVE TO EDIT ACCORDINGLY

# EXAMPLE: if you want to use the config file and the latest numbered release docker image the result will be:

# services:
#   api:
#     volumes:
#     - type: bind
#       source: ./librechat.yaml
#       target: /app/librechat.yaml
#     image: ghcr.io/danny-avila/librechat:latest

# ---------------------------------------------------

# services:

# # USE LIBRECHAT CONFIG FILE
#   api:
#     volumes:
#     - type: bind
#       source: ./librechat.yaml
#       target: /app/librechat.yaml

# # LOCAL BUILD
#   api:
#     image: librechat
#     build:
#       context: .
#       target: node

# # BUILD FROM LATEST IMAGE
#   api:
#     image: ghcr.io/danny-avila/librechat-dev:latest

# # BUILD FROM LATEST IMAGE (NUMBERED RELEASE)
#   api:
#     image: ghcr.io/danny-avila/librechat:latest

# # BUILD FROM LATEST API IMAGE
#   api:
#     image: ghcr.io/danny-avila/librechat-dev-api:latest

# # BUILD FROM LATEST API IMAGE (NUMBERED RELEASE)
#   api:
#     image: ghcr.io/danny-avila/librechat-api:latest

# # ADD SAML CERT FILE
#   api:
#     volumes:
#     - type: bind
#       source: ./your_cert.pem
#       target: /app/your_cert.pem

# # ADD MONGO-EXPRESS
#   mongo-express:
#     image: mongo-express
#     container_name: mongo-express
#     environment:
#       ME_CONFIG_MONGODB_SERVER: mongodb
#       ME_CONFIG_BASICAUTH_USERNAME: admin
#       ME_CONFIG_BASICAUTH_PASSWORD: password
#     ports:
#       - '8081:8081'
#     depends_on:
#       - mongodb
#     restart: always

# # USE MONGODB V4.4.18 - FOR OLDER CPU WITHOUT AVX SUPPORT
#   mongodb:
#     image: mongo:4.4.18

# # DISABLE THE MONGODB CONTAINER - YOU NEED TO SET AN ALTERNATIVE MONGODB URI IN THE .ENV FILE
#   api:
#     environment:
#       - MONGO_URI=${MONGO_URI}
#   mongodb:
#     image: tianon/true
#     command: ""
#     entrypoint: ""

# # EXPOSE MONGODB PORTS - USE CAREFULLY, THIS MAKES YOUR DATABASE VULNERABLE TO ATTACKS
#   mongodb:
#     ports:
#       - 27018:27017

# # DISABLE MEILISEARCH
#   meilisearch:
#     profiles:
#       - donotstart

# # EXPOSE MEILISEARCH PORTS - DO NOT USE THE DEFAULT VALUE FOR THE MASTER KEY IF YOU DO THIS
#   meilisearch:
#     ports:
#       - 7700:7700

# # USE RAG API IMAGE WITH LOCAL EMBEDDINGS SUPPORT
#  rag_api:
#    image: ghcr.io/danny-avila/librechat-rag-api-dev:latest
# # For Linux user:
#    extra_hosts:
#      - "host.docker.internal:host-gateway"

# # ADD OLLAMA
#  ollama:
#    image: ollama/ollama:latest
#    deploy:
#      resources:
#        reservations:
#          devices:
#            - driver: nvidia
#              capabilities: [compute, utility]
#    ports:
#      - "11434:11434"
#    volumes:
#      - ./ollama:/root/.ollama

# # ADD LITELLM BASIC - NEED TO CONFIGURE litellm-config.yaml, ONLY NEED ENV TO ENABLE REDIS FOR CACHING OR LANGFUSE FOR MONITORING
#  litellm:
#    image: ghcr.io/berriai/litellm:main-latest
#    volumes:
#      - ./litellm/litellm-config.yaml:/app/config.yaml
#      - ./litellm/application_default_credentials.json:/app/application_default_credentials.json # only if using Google Vertex
#    ports:
#      - "4000:8000"
#    command: [ "--config", "/app/config.yaml", "--port", "8000", "--num_workers", "8" ]
#    environment:
#      OPENAI_API_KEY: none ## needs to be set if ollama's openai api compatibility is used
#      GOOGLE_APPLICATION_CREDENTIALS: /app/application_default_credentials.json ## only if using Google Vertex
#      REDIS_HOST: redis
#      REDIS_PORT: 6379
#      REDIS_PASSWORD: RedisChangeMe
#      LANGFUSE_PUBLIC_KEY: pk-lf-RandomStringFromLangfuseWebInterface
#      LANGFUSE_SECRET_KEY: sk-lf-RandomStringFromLangfuseWebInterface
#      LANGFUSE_HOST: http://langfuse-server:3000

# # ADD LITELLM CACHING
#  redis:
#    image: redis:7-alpine
#    command:
#    - sh
#    - -c # this is to evaluate the $REDIS_PASSWORD from the env
#    - redis-server --appendonly yes --requirepass $$REDIS_PASSWORD ## $$ because of docker-compose
#    environment:
#      REDIS_PASSWORD: RedisChangeMe
#    volumes:
#    - ./redis:/data

# # ADD LITELLM MONITORING
#  langfuse-server:
#    image: ghcr.io/langfuse/langfuse:latest
#    depends_on:
#      - db
#    ports:
#      - "3000:3000"
#    environment:
#      - NODE_ENV=production
#      - DATABASE_URL=postgresql://postgres:PostgresChangeMe@db:5432/postgres
#      - NEXTAUTH_SECRET=ChangeMe
#      - SALT=ChangeMe
#      - NEXTAUTH_URL=http://localhost:3000
#      - TELEMETRY_ENABLED=${TELEMETRY_ENABLED:-true}
#      - NEXT_PUBLIC_SIGN_UP_DISABLED=${NEXT_PUBLIC_SIGN_UP_DISABLED:-false}
#      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=${LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES:-false}
#  db:
#    image: postgres
#    restart: always
#    environment:
#      - POSTGRES_USER=postgres
#      - POSTGRES_PASSWORD=PostgresChangeMe
#      - POSTGRES_DB=postgres
#    volumes:
#      - ./postgres:/var/lib/postgresql/data


# 备份文件命令
# doppler run -- docker compose exec db-backup bash backup-now
# 备份数据库命令 mongo + vector
# doppler run -- docker compose exec files-backup backup

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: 'crpi-3qv8qlhd6grgh1k4.cn-hangzhou.personal.cr.aliyuncs.com/xuqesj09/librechat:latest'
    ports:
      - '${PORT}:${PORT}'
    volumes:
      - type: bind
        source: ./librechat.yaml
        target: /app/librechat.yaml

  # https反代功能主要是加了下面这段
  reverse-proxy:
    image: nginx:latest
    container_name: librechat-ssl-proxy
    restart: always
    ports:
      # 宿主机56150的端口:容器内
      # 相当于访问宿主机前的56150实际会访问容器内443
      # 容器内的监听443端口和访问容器443以后转发到实际的服务端口${PORT}是在 nginx.conf 里配置的
      - "56150:443"  # 公开的 HTTPS 端口
    volumes:
      # 配置文件和证书的路径映射
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs/nginx.crt:/etc/nginx/nginx.crt:ro
      - ./nginx/certs/nginx.key:/etc/nginx/nginx.key:ro
    depends_on:
      - api
    networks:
      - default

  db-backup:
    container_name: librechat_db_backup
    image: tiredofit/db-backup:4.1.18
    restart: always
    depends_on:
      - vectordb
      - mongodb
    volumes:
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TIMEZONE=Asia/Shanghai
      - CONTAINER_ENABLE_MONITORING=FALSE

      # ==========================================
      # 数据库 01: Postgres (VectorDB)
      # ==========================================
      - DB01_TYPE=pgsql
      - DB01_HOST=vectordb
      - DB01_NAME=mydatabase
      - DB01_USER=myuser
      - DB01_PASS=mypassword
      - DB01_PORT=5432

      # 调度与策略
      - DB01_BACKUP_INTERVAL=1440
      - DB01_BACKUP_BEGIN=0300
      - DB01_BACKUP_LOCATION=S3
      - DB01_CLEANUP_TIME=525600
      - DB01_COMPRESSION=ZSTD

      # S3 配置 (Bitiful)
      - DB01_S3_PROTOCOL=https
      - DB01_S3_HOST=s3.bitiful.net
      - DB01_S3_REGION=us-east-1
      - DB01_S3_BUCKET=${BACKUP_S3_BUCKET:-docker-backup}
      - DB01_S3_PATH=${BACKUP_S3_PATH:-librechat-db-backups}
      - DB01_S3_KEY_ID=${BACKUP_S3_ACCESS_KEY}
      - DB01_S3_KEY_SECRET=${BACKUP_S3_SECRET_KEY}

      # ==========================================
      # 数据库 02: MongoDB
      # ==========================================
      - DB02_TYPE=mongo
      - DB02_HOST=mongodb
      - DB02_NAME=LibreChat
      - DB02_PORT=27017

      # 调度与策略 (与 DB01 保持一致)
      - DB02_BACKUP_INTERVAL=1440
      - DB02_BACKUP_BEGIN=0300
      - DB02_BACKUP_LOCATION=S3
      - DB02_CLEANUP_TIME=525600
      - DB02_COMPRESSION=GZ

      # S3 配置 (必须为 DB02 单独再写一遍，确保生效)
      - DB02_S3_PROTOCOL=https
      - DB02_S3_HOST=s3.bitiful.net
      - DB02_S3_REGION=us-east-1
      - DB02_S3_BUCKET=${BACKUP_S3_BUCKET:-docker-backup}
      - DB02_S3_PATH=${BACKUP_S3_PATH:-librechat-db-backups}
      - DB02_S3_KEY_ID=${BACKUP_S3_ACCESS_KEY}
      - DB02_S3_KEY_SECRET=${BACKUP_S3_SECRET_KEY}

  files-backup:
    container_name: librechat_files_backup
    image: offen/docker-volume-backup:v2
    restart: always
    environment:
      - TZ=Asia/Shanghai
      - BACKUP_CRON_EXPRESSION=30 3 * * *
      - BACKUP_FILENAME=librechat-files-%Y%m%d-%H%M%S.tar.gz
      - BACKUP_PRUNING_PREFIX=librechat-files-
      - BACKUP_RETENTION_DAYS=30
      - AWS_S3_BUCKET_NAME=${BACKUP_S3_BUCKET:-docker-backup}
      - AWS_S3_PATH=librechat-files-backups
      - AWS_ENDPOINT=s3.bitiful.net
      - AWS_ENDPOINT_PROTO=https
      - AWS_S3_BUCKET_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=${BACKUP_S3_ACCESS_KEY}
      - AWS_SECRET_ACCESS_KEY=${BACKUP_S3_SECRET_KEY}
    volumes:
      - ./uploads:/backup/uploads:ro
      - ./images:/backup/images:ro
      - ./.env:/backup/env_file:ro
